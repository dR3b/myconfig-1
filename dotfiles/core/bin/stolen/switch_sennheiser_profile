#!/usr/bin/env bash

# stolen from: https://github.com/mihaeu/dotfiles/blob/master/scripts/switch_sennheiser_profile (MIT)

set -o errexit
set -o nounset
set -o pipefail

export LC_ALL=C

function main {
  readonly sennheiser_profile="$(pactl list cards | grep 'MB 660' -C10)"
  if [[ -z "$sennheiser_profile" ]]; then
    echo "could not determine \$sennheiser_profile, headset probably not connected"
    exit 1
  fi
  readonly pactl_name="$(echo $sennheiser_profile | grep 'Name: ' | tail -n1 | sed -r 's/.*Name://' | cut -d' ' -f2)"
  if [[ -z "$pactl_name" ]]; then
    echo "could not determine \$pactl_name, headset probably not connected"
    exit 1
  fi
  readonly pactl_active_profile="$(echo $sennheiser_profile | grep -oP 'Active Profile: ([^ ]+)' | sed -r 's/.*: *//')"
  if [[ -z "$pactl_active_profile" ]]; then
    echo "could not determine \$pactl_active_profile, headset probably not connected"
    exit 1
  fi
  readonly pactl_other_profile="$(echo $sennheiser_profile | grep -oP 'profile.s.: .+' | sed -r 's/.*: *//;s/, //' | sed -r "s/${pactl_active_profile}//")"
  if [[ -z "$pactl_other_profile" ]]; then
    echo "could not determine \$pactl_other_profile, headset probably not connected"
    exit 1
  fi

  pactl set-card-profile "${pactl_name}" "${pactl_other_profile}"
  echo "$pactl_other_profile"
}

main "$@"
